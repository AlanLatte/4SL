# 4sl (Script for Self-Signed SSL)

**4sl** — это простой bash-скрипт для управления самоподписанными SSL‑сертификатами. Он позволяет:

- Создавать новые сертификаты для **Nginx** или **Docker** (с приватными ключами, dhparam);
- Удалять существующие сертификаты;
- Переподписывать (renew) сертификаты, если срок истекает менее чем через 7 дней;
- Настраивать автоматическую еженедельную проверку срока действия (через cron);
- Отображать текущие сроки действия всех сертификатов;
- Удалять сертификаты по имени домена без указания службы (Nginx/Docker).

Скрипт также ведёт лог всех действий в файле `/var/log/4sl.log`.

---

## Установка

1. Склонируйте репозиторий или загрузите сам скрипт:

   ```bash
   curl -o 4sl.sh https://raw.githubusercontent.com/AlanLatte/4SL/main/4sl.sh
   ```

2. Сделайте скрипт исполняемым и переместите его, например, в `/usr/local/bin/`:

   ```bash
   chmod +x 4sl.sh
   sudo mv 4sl.sh /usr/local/bin/4sl
   ```

3. Проверьте, что скрипт **4sl** исполняется:

   ```bash
   4sl --help
   ```

### Одна команда
```bash
curl https://raw.githubusercontent.com/AlanLatte/4SL/main/4sl.sh > 4sl.sh; chmod +x ./4sl.sh; mv ./4sl.sh /usr/local/bin/4sl
```
---

## Краткая справка (Usage)

```text
4sl [OPTIONS] [ARGS]

Options / Arguments (можно комбинировать):

  -h, --help                     Показать эту справку о скрипте.
  --update                       Обновить 4sl до последней версии.

  -exp, --expirations            Показать срок действия всех сертификатов
                                 (аналог openssl x509 -enddate).

  --remove <domain>             Удалить сертификаты (CRT, KEY, DH, Snippet) для <domain>.

  -s, --ssl                      Создать новый SSL-сертификат.
  -d, --delete                   Удалить существующий SSL-сертификат.

  --renew-ssl [auto|manual]     Проверка и переподписание (renew).
    auto      -> Добавить/обновить cron-задачу (раз в неделю).
                 Если осталось менее 7 дней до истечения,
                 сертификат пересоздаётся автоматически.
    manual    -> Выполнить проверку прямо сейчас (без cron).
                 Если осталось < 7 дней, пересоздать.

  --nginx <domain>              Считать, что сертификат предназначен для Nginx.
                                <domain> обязателен при --nginx.
  --docker                      Считать, что сертификат предназначен для Docker
                                (использует имя 'docker' без домена).

  --silent                      Тихий режим: не задавать вопросов при генерации,
                                установить Subject = /CN=<domain>.
  -y                            Всегда отвечать 'Yes' на вопросы (например, при удалении).
```

---

## Структура директорий и файлов

По умолчанию скрипт использует такие пути (при необходимости можно менять внутри кода):
- **`/etc/4sl`** — базовый каталог скрипта.
  - **`/etc/4sl/certs`** — хранение файлов `.crt`
  - **`/etc/4sl/private`** — хранение файлов `.key`
  - **`/etc/4sl/dhparam`** — хранение файлов `.pem` (для `dhparam`)
  - **`/etc/4sl/nginx/snippets`** — хранение nginx‑конфигураций для SSL (далее связывается в `/etc/nginx/snippets/ssl/<domain>`)

Также скрипт ведёт журнал (**лог**) в файле:
- **`/var/log/4sl.log`**

---

## Примеры использования

### 1. Создание сертификата для Nginx

```bash
4sl --ssl --nginx example.com
```
- Спросит подтверждение и создаст файлы:
  - `/etc/4sl/certs/example.com.crt`
  - `/etc/4sl/private/example.com.key`
  - `/etc/4sl/dhparam/example.com.pem` (DH-параметры)
  - `/etc/4sl/nginx/snippets/example.com` (содержит `ssl_certificate`, `ssl_certificate_key`, `ssl_dhparam`)
  - Символьная ссылка `/etc/nginx/snippets/ssl/example.com -> /etc/4sl/nginx/snippets/example.com`

> Чтобы скрипт отработал в тихом режиме, используйте флаги: `--silent -y`.

### 2. Удаление сертификата для Nginx

```bash
4sl --delete --nginx example.com
```
- Покажет, какие файлы будут удалены, спросит подтверждение и удалит.

### 3. Создание сертификата для Docker

```bash
4sl --ssl --docker
```
- Создаст сертификаты с именем `docker` ( `docker.crt`, `docker.key` ) без DH‑параметров.

### 4. Показ сроков действия всех сертификатов

```bash
4sl --expirations
```
- Показывает список всех `.crt` в `/etc/4sl/certs`, их даты истечения. Если до конца срока осталось >31 дня, проставляет `[ + ]`, иначе `[ - ]`.

### 5. Переподписание (renew) вручную

```bash
4sl --renew-ssl manual --nginx example.com
```
- Скрипт проверит, сколько осталось дней до истечения сертификата `example.com.crt`.
- Если осталось менее 7 дней — **пересоздаст** (удалит старый `.crt`, `.key`, сгенерирует заново).
- Если осталось более 7 дней, переподписывать не будет.
- **manual** не создаёт cron‑задачу.

### 6. Переподписание (renew) с авто-проверкой (cron)

```bash
4sl --renew-ssl auto --nginx example.com
```
- То же самое, но вдобавок создаёт еженедельную `cron`-задачу в `/etc/cron.weekly/`, чтобы скрипт периодически проверял срок сертификата. При оставшихся <7 днях сертификат пересоздаётся автоматически.

### 7. Удаление сертификата по домену (без указания --nginx/--docker)

```bash
4sl --remove example.com
```
- Удаляет все файлы, связанные с `example.com`, из `certs/`, `private/`, `dhparam/`, `snippets/ssl/`.

### 8. Обновление самого скрипта

```bash
4sl --update
```
- Загружает последнюю версию `4sl.sh` из GitHub-репозитория и устанавливает её поверх текущей.

### 9. Комбинированная команда (создать + renew + тихий режим)

```bash
4sl --ssl --nginx example.com --renew-ssl auto --silent -y
```
- **Создаёт** сертификат для `example.com` (без вопросов),
- Настраивает **авто‑renew** (cron) раз в неделю,
- Не спрашивает подтверждений при удалении старых файлов (если остались).

---

## Логика при переподписании (renew)

При вызове:
```bash
4sl --renew-ssl auto|manual --nginx <domain>
```
1. Скрипт смотрит на `enddate` сертификата.
2. Если он **не найден** (файл не существует) — «Нечего переподписывать».
3. Если осталось больше 7 дней — «Переподписание не требуется».
4. Если осталось меньше 7 дней — удаляет старые `.crt` / `.key` и генерирует заново.
   - Для `--nginx` удаляет ещё и старый `dhparam` ( `.pem` ), пересоздаёт новый.
5. Если режим `auto` — создаёт (или обновляет) еженедельную **cron**-задачу `/etc/cron.weekly/4sl-renew-<domain>`, которая выполняет `--renew-ssl manual ...` в фоне.

## Логи

Все действия скрипт **дублирует** на экран и пишет в файл:
```
/var/log/4sl.log
```
Например, при создании сертификата, удалении или переподписании вы можете посмотреть журнал, чтобы увидеть все шаги.

---

## Варианты кастомизации

- **Изменить пути хранения** (вместо `/etc/4sl/...` можно выбрать другой каталог).
- **Подправить сроки** (по умолчанию сертификаты на `-days 365`).
- **Настроить крон‑задачу** не в `/etc/cron.weekly/`, а в другом cron-тайминге (например, `cron.daily` или `cron.monthly`).

---

## Troubleshooting

1. **Permission denied**:
   Убедитесь, что у вас достаточно прав (sudo) для записи в `/etc/4sl/` и `/usr/local/bin/`.
2. **Nginx / Docker не найден**:
   Скрипт проверяет зависимости. Установите их:
   ```bash
   sudo apt install nginx -y
   # или
   curl -fsSL https://get.docker.com | sh
   ```
3. **Скрипт не видит сертификат**:
   Убедитесь, что имя домена ( `example.com` ) соответствует названию `.crt` / `.key`.

---

## Авторы

- **Автор**: *AlanLatte*

---
